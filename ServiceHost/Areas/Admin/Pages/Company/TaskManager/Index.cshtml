@page
@using _0_Framework.Application
@model ServiceHost.Areas.Admin.Pages.Company.TaskManager.IndexModel
@inject _0_Framework.Application.IAuthHelper AuthHelper;
@{
	var status = new Dictionary<string, int>();

	status.Add("NOTSET", CompanyManagment.App.Contracts.TaskStatus.TaskStatusEnums.NOTSET);
	status.Add("REJECTED", CompanyManagment.App.Contracts.TaskStatus.TaskStatusEnums.REJECTED);
	status.Add("UNAPPROVED", CompanyManagment.App.Contracts.TaskStatus.TaskStatusEnums.UNAPPROVED);
	status.Add("SENIOR_APPROVAL", CompanyManagment.App.Contracts.TaskStatus.TaskStatusEnums.SENIOR_APPROVAL);
	status.Add("MANAGER_APPROVAL", CompanyManagment.App.Contracts.TaskStatus.TaskStatusEnums.MANAGER_APPROVAL);
	status.Add("ALL", CompanyManagment.App.Contracts.TaskStatus.TaskStatusEnums.ALL);
	
	var currentAccount = AuthHelper.CurrentAccountInfo();

	var today = DateTime.Now.Date;
}

@{
	Layout = "Shared/_AdminLayout";
	ViewData["title"] = "مدیریت وظایف";
}
<style>
	table tbody > tr > td p {
        font-size: 12px !important;
        text-align: center !important;
        vertical-align: middle;

    }
	 .select2-container .select2-selection--single {
        height: 34px;
    }
	.tooltip-container {
        cursor: pointer;
        position: relative;
        display: inline-block;
    }

    .tooltip2-container {
        cursor: pointer;
        position: relative;
        display: inline-block;
    }

    .tooltip {
        opacity: 0;
        z-index: 99;
        color: #000;
        width: 355px;
        display: block;
        font-size: 14px;
        font-family: 'IranSans';
        padding: 5px 10px;
        border-radius: 3px;
        text-align: center;
        /*text-shadow: 1px 1px 2px #111;*/
        background: #dbf5ec;
        border: 1px solid #dbf5ec;
        box-shadow: 0 0 3px rgba(0,0,0,0.5);
        -webkit-transition: all .2s ease-in-out;
        -moz-transition: all .2s ease-in-out;
        -o-transition: all .2s ease-in-out;
        -ms-transition: all .2s ease-in-out;
        transition: all .2s ease-in-out;
        -webkit-transform: scale(0);
        -moz-transform: scale(0);
        -o-transform: scale(0);
        -ms-transform: scale(0);
        transform: scale(0);
        position: absolute;
        right: -75px;
        /*bottom: 10px;*/
		top: -45px
    }

    .tooltip:before, .tooltip:after {
        content: '';
        border-left: 10px solid transparent;
        border-right: 10px solid transparent;
        border-top: 10px solid #dbf5ec;
        position: absolute;
        bottom: -10px;
        left: 70%;
    }

    .tooltip-container:hover .tooltip, a:hover .tooltip {
        opacity: 1;
        -webkit-transform: scale(1);
        -moz-transform: scale(1);
        -o-transform: scale(1);
        -ms-transform: scale(1);
        transform: scale(1);
    }

    .tooltip2 {
        opacity: 0;
        z-index: 99;
        color: #fff;
        width: 220px;
        display: block;
        font-size: 14px;
        font-family: 'IranSans';
        padding: 5px 10px;
        border-radius: 3px;
        text-align: center;
        /*text-shadow: 1px 1px 2px #111;*/
        background: #e67e22;
        border: 1px solid #e67e22;
        box-shadow: 0 0 3px rgba(0,0,0,0.5);
        -webkit-transition: all .2s ease-in-out;
        -moz-transition: all .2s ease-in-out;
        -o-transition: all .2s ease-in-out;
        -ms-transition: all .2s ease-in-out;
        transition: all .2s ease-in-out;
        -webkit-transform: scale(0);
        -moz-transform: scale(0);
        -o-transform: scale(0);
        -ms-transform: scale(0);
        transform: scale(0);
        position: absolute;
        right: -90px;
        bottom: 40px;
    }

    .tooltip2:before, .tooltip2:after {
        content: '';
        border-left: 10px solid transparent;
        border-right: 10px solid transparent;
        border-top: 10px solid #e67e22;
        position: absolute;
        bottom: -10px;
        left: 50%;
    }

    .tooltip2-container:hover .tooltip2, a:hover .tooltip2 {
        opacity: 1;
        -webkit-transform: scale(1);
        -moz-transform: scale(1);
        -o-transform: scale(1);
        -ms-transform: scale(1);
        transform: scale(1);
    }
</style>
<div>
    @if (currentAccount.RoleId == 1)
    {
        <div>
            <div class="col-sm-12 m-r-10">
			<p>
                <a id="btnPopModal" href="#showmodal=@Url.Page("/Company/TaskManager/Index", "CreateOrEdit")" class="btn btn-success btn-rounded waves-effect waves-light m-b-5" style=" background-color: #f5f5f5; border-color: #0f9500; font-family: 'Web_Yekan' !important; color: #0f9500 !important; margin-right: 10px "> <i class="fa fa-user-plus" style="padding-left: 3px; font-size: 14px; color: #0f9500 !important "></i> تعریف وظیفه  جدید </a>
			</p>
			<p class="pull-left">
                <a id="btnPopModal" href="#showmodal=@Url.Page("/Company/TaskManager/Index", "CreateOrEditTaskTitle")" class="btn btn-success btn-rounded waves-effect waves-light m-b-5" style=" background-color: #f5f5f5; border-color: #448bdb; font-family: 'Web_Yekan' !important; color: #448bdb !important; margin-left: 10px "> <i class="fa fa-calendar" style="padding-right: 3px; font-size: 14px; color: #448bdb !important "></i> لیست عناوین وظایف </a>
            </p>
		</div>
	</div>
    }

	<div class="col-sm-12">
		<div class="panel-group panel-group-joined" id="accordion-test">

			<div class="panel panel-default" style="border-radius: 15px !important;">
				<div class="panel-heading" style="background-color: #545353 !important">
					<h4 class="panel-title" style="color: #edebeb !important; display: inline;">
						<a data-toggle="collapse" data-parent="#accordion-test" href="#collapseOne" class="collapsed" style="display: inline;">
							جستجوی وظیفه ها
						</a>
					</h4>

				</div>
				<div id="collapseOne" class="panel-collapse collapse in ">
					<div class="panel-body" style="padding-top: 15px; padding-bottom: 15px;">
						@*===================================================================================================================*@

						<div class="row">
							<div class="col-sm-12">
								<form class="form-inline" role="form" asp-action="./Index" method="GET" name="search-theme-form" id="search-theme-form" autocomplete="off">
									<div class="form-group col-sm-12">
										<div class="row">
											<div class="col-sm-2 pull-right m-b-15">
												<select asp-for="searchModel.Commander_Id" class="form-control select-city" style="width: 100%">
													<option value="0">آمر</option>	
													
													@foreach (var item in Model.searchModel.Commanders)
													{
													   <option value="@item.Id">@item.Fullname</option>
													}

												</select>
											</div>
											<div class="col-sm-2 pull-right m-b-15">
												<select asp-for="searchModel.SeniorUser_Id" class="form-control select-city" style="width: 100%">
													<option value="0">کاربر</option>

													@foreach (var item in Model.searchModel.SeniorUsers)
													{
													   <option value="@item.Id">@item.Fullname</option>
													}

												</select>
											</div>										
											<div class="col-sm-2 pull-right m-b-15">
												<select asp-for="searchModel.TaskTitle_Id" class="form-control select-city" style="width: 100%">
													<option value="0">عنوان کار</option>
													
													@foreach (var item in Model.searchModel.TaskTitles)
													{
													   <option value="@item.Id">@item.Title</option>
													}

												</select>
											</div>
											<div class="col-sm-2 pull-right m-b-15">
												<input asp-for="searchModel.Customer" class="form-control" style="width: 100%" placeholder="طرف وظیفه">
											</div>
											<div class="col-sm-2 pull-right m-b-15">
												<input asp-for="searchModel.Description" class="form-control" style="width: 100%" placeholder="توضیحات">
											</div>
                                            <div class="col-xs-12"></div>
											<div class="col-sm-2 pull-right m-b-15">
												<input asp-for="searchModel.TaskDateFrom" class="form-control inpt" dir="ltr" maxlength="10" onchange="validDate(this);" style="width: 100%; text-align: right" placeholder="تاریخ شروع وظیفه">
											</div>
											<div class="col-sm-2 pull-right m-b-15">
												<input asp-for="searchModel.TaskDateTo" class="form-control inpt" dir="ltr" maxlength="10" onchange="validDate(this);" style="width: 100%; text-align: right" style="width: 100%" placeholder="تاریخ پایان وظیفه">
											</div>
											<div class="col-sm-2 pull-right m-b-15">
												<select asp-for="searchModel.ReferralStatus" class="form-control select-city select-status" style="width: 100%">
													@*<option value="" selected>وضعیت ارجاع</option>*@
													<option value="@status["ALL"]" selected>وضعیت ارجاع (همه)</option>
													<option value="@status["NOTSET"]">ارجاع نشده</option>
													<option value="@status["UNAPPROVED"]">تایید نشده</option>
													<option value="@status["REJECTED"]">رد شده</option>
													<option value="@status["MANAGER_APPROVAL"]">ارجاع شده</option>
												</select>
											</div>
											<div class="col-sm-2 pull-right m-b-15">
												<select asp-for="searchModel.DeadlineExtensionStatus" class="form-control select-city select-status" style="width: 100%">
													@*<option value="" selected>وضعیت تمدید</option>*@
													<option value="@status["ALL"]" selected>وضعیت تمدید (همه)</option>
													<option value="@status["NOTSET"]">تمدید نشده</option>
													<option value="@status["UNAPPROVED"]">تایید نشده</option>
													<option value="@status["REJECTED"]">رد شده</option>
													<option value="@status["MANAGER_APPROVAL"]">تمدید شده</option>
												</select>
											</div>
											<div class="col-sm-2 pull-right m-b-15">
												<select asp-for="searchModel.ImpossibilityStatus" class="form-control select-city select-status" style="width: 100%">
													@*<option value="" selected>وضعیت عدم امکان</option>*@
													<option value="@status["ALL"]" selected>وضعیت عدم امکان (همه)</option>
													<option value="@status["NOTSET"]">عدم امکان نشده</option>
													<option value="@status["UNAPPROVED"]">تایید نشده</option>
													<option value="@status["REJECTED"]">رد شده</option>
													<option value="@status["MANAGER_APPROVAL"]">عدم امکان شده</option>
												</select>
											</div>
											<div class="col-sm-2 pull-right m-b-15">
												<select asp-for="searchModel.DoneStatus" class="form-control select-city select-status" style="width: 100%">
													@*<option value="" selected>وضعیت انجام</option>*@
													<option value="@status["ALL"]" selected>وضعیت انجام (همه)</option>
													<option value="@status["NOTSET"]">عدم انجام نشده</option>
													<option value="@status["UNAPPROVED"]">تایید نشده</option>
													<option value="@status["REJECTED"]">رد شده</option>
													<option value="@status["MANAGER_APPROVAL"]">عدم انجام شده</option>
												</select>
											</div>
									
										</div>

										<div class="row" style="margin-top: 15px">


											<div class="col-lg-9">
											</div>

											<div class="col-lg-3">
												<button type="submit" class="btn btn-success btn-rounded waves-effect waves-light m-b-5" style="border-bottom-left-radius: 0px; border-top-left-radius: 0px; background-color: #950000; border-color: #950000; font-family: 'Web_Yekan' !important; margin-left: -3px"> <i class="fa fa-search" style="padding-left: 3px; font-size: 14px;"></i> جستجو</button>
												<a class="btn btn-info btn-rounded waves-effect waves-light m-b-5" style="border-bottom-right-radius: 0px; border-top-right-radius: 0px; background-color: #545353; border-color: #545353; font-family: 'Web_Yekan' !important;" asp-page="./Index">مشاهده همه</a>
											</div>
										</div>
									</div>
								</form>
							</div>
						</div>
					</div>
				</div>
			</div>

		</div>
	</div>


	    <div class="col-sm-12">
        <div class="panel panel-default">
            <div class="panel-heading">
                <h3 class="panel-title"><i class="fa fa-list" style="padding-left: 3px; font-size: 14px"></i> لیست وظیفه ها</h3>
            </div>
            <div class="panel-body">
                <div class="row">
                    <div class="col-sm-12 col-sm-12 col-xs-12">
                        <table id="datatable" class="table table-striped table-bordered">
                            <thead>
                                <tr>
                                    <th>#</th>

                                    <th style=" font-size: 10px; text-align: center"> آمر </th>
                                    <th style=" font-size: 10px; text-align: center"> نام کاربر </th>
                                    <th style=" font-size: 10px; text-align: center"> ارجاع گیرنده </th>
                                    <th style=" font-size: 10px; text-align: center"> عنوان کار </th>
                                    <th style=" font-size: 10px; text-align: center"> تاریخ وظیفه </th>
                                    <th style=" font-size: 10px; text-align: center"> طرف وظیفه </th>
                                    <th style=" font-size: 10px; text-align: center"> توضیحات </th>
                                    <th></th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody>
								@{ var i = 1; }
								@foreach(var item in Model.viewModels)
								{
									var background = "";

									if(item.TaskDate.ToGeorgianDateTime().Date == today)
										background = "#ff9190";
										
									if(today - item.TaskDate.ToGeorgianDateTime().Date == TimeSpan.FromDays(1))
										background = "#fbd38e";

                                    <tr style="background: @background">
                                        <td>@i</td>
                                        <td> 
                                            <p>@item.CommanderName</p>    
                                        </td>
                                        <td>
                                            <p>@item.SeniorUserName</p>
                                        </td>
                                        <td> 
                                            <p>@item.ReferralRecipientName</p>    
                                        </td>
                                        <td>
											<p>@item.TaskTitle</p>
										</td>
										<td>
											<p>@item.TaskDate</p>
										</td>
                                        <td>
											<p>@item.CustomerName</p>
										</td>
                                        <td>
											<p>@item.Description</p>
										</td>
                                        <td>
											@if(currentAccount.RoleId == 1)
											{
												if (@item.TaskStatus.ReferralStatus == status["NOTSET"] || @item.TaskStatus.ReferralStatus == status["REJECTED"])
												{
													<button type="button" class="btn btn-danger" data-toggle="modal" data-target="#ReferralModal">ارجاع</button>
													<div id="ReferralModal" class="modal fade" role="dialog">
														<div class="modal-dialog">
															<div class="modal-content">
																<div class="modal-body">
																	<h5>لطفا کاربر مورد نظر را جهت ارجاع انتخاب کنید</h5>
                                                                    <div class="form-group">
																		<select class="form-control select2-tag" id="refferalUser">
																			<option value="0">لطفا انتخاب کنید ...</option>
																			@foreach (var user in Model.refferalUsers)
																			{
																				<option value="@user.Id">@user.Fullname</option>
																			}
																		</select>
																	</div>	
																</div>
																<div class="modal-footer m-b-10">
																	<button type="button" onclick="SetRefferalUser(@item.Id)" class="btn btn-success btn-rounded waves-effect waves-light" style="float: left">ذخیره</button>
																	<button type="button" class="btn btn-default btn-rounded waves-effect waves-light m-b-5" data-dismiss="modal" style="float: left">بستن</button>
																</div>
															</div>
														</div>
													</div>
													
												}
												else if(@item.TaskStatus.ReferralStatus != status["MANAGER_APPROVAL"])
												{
													<button type="button" class="btn btn-danger" data-toggle="modal" data-target="#ReferralApprovalModal">تایید ارجاع</button>
													<div id="ReferralApprovalModal" class="modal fade" role="dialog">
														<div class="modal-dialog">
															<div class="modal-content">
																<div class="modal-body">
																	<h5>
																		کاربر 
																		<b>"@item.TaskStatus.ReferralRegUserFullName"</b>
																		 جهت ارجاع وظیفه، کاربر 
																		<b>"@item.TaskStatus.ReferralUserFullName"</b>
																		  را انتخاب کرده است. آیا تایید می کنید ؟
																	</h5>
																</div>
																<div class="modal-footer m-b-10">
																	<button type="button" onclick="SetRefferalUserApproval(@item.Id, true)" class="btn btn-success btn-rounded waves-effect waves-light" style="float: left">تایید</button>
																	<button type="button" onclick="SetRefferalUserApproval(@item.Id, false)" class="btn btn-danger btn-rounded waves-effect waves-light m-b-5" style="float: left">عدم تایید</button>
																</div>
															</div>

														</div>
													</div>
												}

												if (@item.TaskStatus.DeadlineExtentionStatus == status["NOTSET"] || @item.TaskStatus.DeadlineExtentionStatus == status["REJECTED"])
												{
													<button type="button" class="btn" data-toggle="modal" data-target="#DeadlineExtentionModal" style="background-color: #f3bf74">تمدید مهلت</button>
													<div id="DeadlineExtentionModal" class="modal fade" role="dialog">
														<div class="modal-dialog modal-sm">
															<div class="modal-content">
																<div class="modal-body">
																	<h5>لطفا تاریخ تمدید مهلت را وارد کنید</h5>
																	<div class="form-group">
																		<input type="text" class="form-control date" dir="ltr" maxlength="10" onchange="validDate(this);" style="width: 100%; text-align: center" id="DeadlineDate">
																		<span class="error"></span>
																	</div>
																	<a class="btn btn-success btn-rounded waves-effect waves-light" onclick="UpdateDate(9)" style="width: 47%;">امروز</a>
																	<a class="btn btn-success btn-rounded waves-effect waves-light" onclick="UpdateDate(0)" style="width: 47%;">فردا</a>
																	<a class="btn btn-success btn-rounded waves-effect waves-light m-t-5" onclick="UpdateDate(1)" style="width: 47%;">پس‌فردا</a>
																	<a class="btn btn-success btn-rounded waves-effect waves-light m-t-5" onclick="UpdateDate(2)" style="width: 47%;">اول هفته</a>
																	<a class="btn btn-success btn-rounded waves-effect waves-light m-t-5" onclick="UpdateDate(4)" style="width: 47%;">اواسط هفته</a>
																	<a class="btn btn-success btn-rounded waves-effect waves-light m-t-5" onclick="UpdateDate(3)" style="width: 47%;">اواخر هغته</a>
																</div>
																<div class="modal-footer m-b-10">
																	<button type="button" onclick="SetDeadlineDate(@item.Id)" class="btn btn-success btn-rounded waves-effect waves-light" style="float: left">ذخیره</button>
																	<button type="button" class="btn btn-default btn-rounded waves-effect waves-light m-b-5" data-dismiss="modal" style="float: left">بستن</button>
																</div>
															</div>
														</div>
													</div>
													
												}
												else if(@item.TaskStatus.DeadlineExtentionStatus != status["MANAGER_APPROVAL"])
												{
													<button type="button" class="btn" data-toggle="modal" data-target="#DeadlineExtentionApprovalModal" style="background-color: #f3bf74">تایید تمدید مهلت</button>
													<div id="DeadlineExtentionApprovalModal" class="modal fade" role="dialog">
														<div class="modal-dialog">
															<div class="modal-content">
																<div class="modal-body">
																	<h5>
																		کاربر 
																		<b>"@item.TaskStatus.ReferralRegUserFullName"</b>
																		 تاریخ 
																		 <b>"@item.TaskStatus.DeadlineExtentionFarsiDate"</b>
																		
																		  را جهت تمدید مهلت انتخاب کرده است. آیا تایید می کنید ؟
																	</h5>
																</div>
																<div class="modal-footer m-b-10">
																	<button type="button" onclick="SetDeadlineExtentionApproval(@item.Id, true)" class="btn btn-success btn-rounded waves-effect waves-light" style="float: left">تایید</button>
																	<button type="button" onclick="SetDeadlineExtentionApproval(@item.Id, false)" class="btn btn-danger btn-rounded waves-effect waves-light m-b-5" style="float: left">عدم تایید</button>
																</div>
															</div>

														</div>
													</div>
												}

												if (@item.TaskStatus.ImpossibilityStatus == status["NOTSET"] || @item.TaskStatus.ImpossibilityStatus == status["REJECTED"])
												{
													<button type="button" class="btn" data-toggle="modal" data-target="#ImpossibilityModal" style="background-color: lightgrey">عدم امکان</button>
													<div id="ImpossibilityModal" class="modal fade" role="dialog">
														<div class="modal-dialog modal-sm">
															<div class="modal-content">
																<div class="modal-body">
																	<h5>لطفا توضیحات مربوط را وارد کنید</h5>
																	<div class="form-group">
																		<textarea class="form-control" id="ImpossibilityDescription"></textarea>
																	</div>
																</div>
																<div class="modal-footer m-b-10">
																	<button type="button" onclick="SetImpossibility(@item.Id)" class="btn btn-success btn-rounded waves-effect waves-light" style="float: left">ذخیره</button>
																	<button type="button" class="btn btn-default btn-rounded waves-effect waves-light m-b-5" data-dismiss="modal" style="float: left">بستن</button>
																</div>
															</div>
														</div>
													</div>
													
												}
												else if(@item.TaskStatus.ImpossibilityStatus != status["MANAGER_APPROVAL"])
												{
													<button type="button" class="btn" data-toggle="modal" data-target="#ImpossibilityApprovalModal" style="background-color: lightgrey">تایید عدم امکان</button>
													<div id="ImpossibilityApprovalModal" class="modal fade" role="dialog">
														<div class="modal-dialog">
															<div class="modal-content">
																<div class="modal-body">
																	<h5>
																		کاربر 
																		<b>"@item.TaskStatus.ImpossibilityRegUserFullName"</b>
																		  عدم امکان انجام این وظیفه را با توضیحات زیر انتخاب کرده است. آیا تایید می کنید ؟
																	</h5>
                                                                    <p>
																		@item.TaskStatus.ImpossibilityDescription
																	</p>
																</div>
																<div class="modal-footer m-b-10">
																	<button type="button" onclick="SetImpossibilityApproval(@item.Id, true)" class="btn btn-success btn-rounded waves-effect waves-light" style="float: left">تایید</button>
																	<button type="button" onclick="SetImpossibilityApproval(@item.Id, false)" class="btn btn-danger btn-rounded waves-effect waves-light m-b-5" style="float: left">عدم تایید</button>
																</div>
															</div>

														</div>
													</div>
												}

												if (@item.TaskStatus.DoneStatus == status["NOTSET"] || @item.TaskStatus.DoneStatus == status["REJECTED"])
												{
													<button type="button" class="btn" data-toggle="modal" data-target="#DoneModal" style="background-color: yellow">انجام شد</button>
													<div id="DoneModal" class="modal fade" role="dialog">
														<div class="modal-dialog modal-sm">
															<div class="modal-content">
																<div class="modal-body">
																	<h5>آیا از انتخاب گزینه "انجام شد" اطمینان دارید ؟</h5>
																</div>
																<div class="modal-footer m-b-10">
																	<button type="button" onclick="SetDone(@item.Id)" class="btn btn-success btn-rounded waves-effect waves-light" style="float: left">ذخیره</button>
																	<button type="button" class="btn btn-default btn-rounded waves-effect waves-light m-b-5" data-dismiss="modal" style="float: left">بستن</button>
																</div>
															</div>
														</div>
													</div>
													
												}
												else if(@item.TaskStatus.DoneStatus != status["MANAGER_APPROVAL"])
												{
													<button type="button" class="btn" data-toggle="modal" data-target="#DoneApprovalModal" style="background-color: yellow">تایید انجام شد</button>
													<div id="DoneApprovalModal" class="modal fade" role="dialog">
														<div class="modal-dialog">
															<div class="modal-content">
																<div class="modal-body">
																	<h5>
																		کاربر 
																		<b>"@item.TaskStatus.DoneRegUserFullName"</b>
																		  گزینه "انجام شد" را انتخاب کرده است. آیا تایید می کنید ؟
																	</h5>
																</div>
																<div class="modal-footer m-b-10">
																	<button type="button" onclick="SetDoneApproval(@item.Id, true)" class="btn btn-success btn-rounded waves-effect waves-light" style="float: left">تایید</button>
																	<button type="button" onclick="SetDoneApproval(@item.Id, false)" class="btn btn-danger btn-rounded waves-effect waves-light m-b-5" style="float: left">عدم تایید</button>
																</div>
															</div>

														</div>
													</div>
												}
											}
											else
											{
												if (@item.TaskStatus.ReferralStatus == status["NOTSET"] || @item.TaskStatus.ReferralStatus == status["REJECTED"])
												{
													<button type="button" class="btn btn-danger" data-toggle="modal" data-target="#ReferralModal">ارجاع</button>
													<div id="ReferralModal" class="modal fade" role="dialog">
														<div class="modal-dialog">
															<div class="modal-content">
																<div class="modal-body">
																	<h5>لطفا کاربر مورد نظر را جهت ارجاع انتخاب کنید</h5>
                                                                    <div class="form-group">
																		<select class="form-control select2-tag" id="refferalUser">
																			<option value="0">لطفا انتخاب کنید ...</option>
																			@foreach (var user in Model.refferalUsers)
																			{
																				<option value="@user.Id">@user.Fullname</option>
																			}
																		</select>
																	</div>	
																</div>
																<div class="modal-footer m-b-10">
																	<button type="button" onclick="SetRefferalUser(@item.Id)" class="btn btn-success btn-rounded waves-effect waves-light" style="float: left">ذخیره</button>
																	<button type="button" class="btn btn-default btn-rounded waves-effect waves-light m-b-5" data-dismiss="modal" style="float: left">بستن</button>
																</div>
															</div>
														</div>
													</div>
													
												}

												if (@item.TaskStatus.DeadlineExtentionStatus == status["NOTSET"] || @item.TaskStatus.DeadlineExtentionStatus == status["REJECTED"])
												{
													<button type="button" class="btn" data-toggle="modal" data-target="#DeadlineExtentionModal" style="background-color: #f3bf74">تمدید مهلت</button>
													<div id="DeadlineExtentionModal" class="modal fade" role="dialog">
														<div class="modal-dialog modal-sm">
															<div class="modal-content">
																<div class="modal-body">
																	<h5>لطفا تاریخ تمدید مهلت را وارد کنید</h5>
																	<div class="form-group">
																		<input type="text" class="form-control date" dir="ltr" maxlength="10" onchange="validDate(this);" style="width: 100%; text-align: center" id="DeadlineDate">
																		<span class="error"></span>
																	</div>
																	<a class="btn btn-success btn-rounded waves-effect waves-light" onclick="UpdateDate(9)" style="width: 47%;">امروز</a>
																	<a class="btn btn-success btn-rounded waves-effect waves-light" onclick="UpdateDate(0)" style="width: 47%;">فردا</a>
																	<a class="btn btn-success btn-rounded waves-effect waves-light m-t-5" onclick="UpdateDate(1)" style="width: 47%;">پس‌فردا</a>
																	<a class="btn btn-success btn-rounded waves-effect waves-light m-t-5" onclick="UpdateDate(2)" style="width: 47%;">اول هفته</a>
																	<a class="btn btn-success btn-rounded waves-effect waves-light m-t-5" onclick="UpdateDate(4)" style="width: 47%;">اواسط هفته</a>
																	<a class="btn btn-success btn-rounded waves-effect waves-light m-t-5" onclick="UpdateDate(3)" style="width: 47%;">اواخر هغته</a>
																</div>
																<div class="modal-footer m-b-10">
																	<button type="button" onclick="SetDeadlineDate(@item.Id)" class="btn btn-success btn-rounded waves-effect waves-light" style="float: left">ذخیره</button>
																	<button type="button" class="btn btn-default btn-rounded waves-effect waves-light m-b-5" data-dismiss="modal" style="float: left">بستن</button>
																</div>
															</div>
														</div>
													</div>
													
												}

												if (@item.TaskStatus.ImpossibilityStatus == status["NOTSET"] || @item.TaskStatus.ImpossibilityStatus == status["REJECTED"])
												{
													<button type="button" class="btn" data-toggle="modal" data-target="#ImpossibilityModal" style="background-color: lightgrey">عدم امکان</button>
													<div id="ImpossibilityModal" class="modal fade" role="dialog">
														<div class="modal-dialog modal-sm">
															<div class="modal-content">
																<div class="modal-body">
																	<h5>لطفا توضیحات مربوط را وارد کنید</h5>
																	<div class="form-group">
																		<textarea class="form-control" id="ImpossibilityDescription"></textarea>
																	</div>
																</div>
																<div class="modal-footer m-b-10">
																	<button type="button" onclick="SetImpossibility(@item.Id)" class="btn btn-success btn-rounded waves-effect waves-light" style="float: left">ذخیره</button>
																	<button type="button" class="btn btn-default btn-rounded waves-effect waves-light m-b-5" data-dismiss="modal" style="float: left">بستن</button>
																</div>
															</div>
														</div>
													</div>
													
												}

												if (@item.TaskStatus.DoneStatus == status["NOTSET"] || @item.TaskStatus.DoneStatus == status["REJECTED"])
												{
													<button type="button" class="btn" data-toggle="modal" data-target="#DoneModal" style="background-color: yellow">انجام شد</button>
													<div id="DoneModal" class="modal fade" role="dialog">
														<div class="modal-dialog modal-sm">
															<div class="modal-content">
																<div class="modal-body">
																	<h5>آیا از انتخاب گزینه "انجام شد" اطمینان دارید ؟</h5>
																</div>
																<div class="modal-footer m-b-10">
																	<button type="button" onclick="SetDone(@item.Id)" class="btn btn-success btn-rounded waves-effect waves-light" style="float: left">ذخیره</button>
																	<button type="button" class="btn btn-default btn-rounded waves-effect waves-light m-b-5" data-dismiss="modal" style="float: left">بستن</button>
																</div>
															</div>
														</div>
													</div>
													
												}
											}
										</td>
                                        <td>
											@if(currentAccount.RoleId == 1)
											{
												<a class="btn btn-warning pull-right m-rl-5 rad deact" href="#showmodal=@Url.Page("./Index", "CreateOrEdit", new { Id = @item.Id })">
													<i class="fa fa-edit ionSize"></i>
												</a>
												<a class="btn btn-danger pull-right m-rl-5 rad deact" onclick="DeleteTask(@item.Id)">
													<i class="fa faSize fa-trash"></i>
												</a>
											}
										</td>
                                    </tr>
									
									i++;
								}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>



@section Script {
    <script src="~/AdminTheme/assets/js/site4.js"></script>
    <script src="~/adminTheme/assets/datatables/jquery.dataTables.min.js"></script>
    <script src="~/adminTheme/assets/datatables/dataTables.bootstrap.js"></script>
    <script>
		$(document).ready(function(){

            $(".select-status").val(@status["ALL"]).trigger('change');
		});

		function SetRefferalUser(taskId)
		{
            var refferalUserId = $("#refferalUser").val();
			
            if (refferalUserId == 0) {

				$.Notification.autoHideNotify('error', 'top center', 'پیام سیستم ', 'لطفا کاربر را انتخاب کنید');
				return;
			}

			$.ajax({
                dataType: 'json',
                type: 'POST',
                url: '@Url.Page("./Index", "SetRefferalUser")',
                headers: { "RequestVerificationToken": $('@Html.AntiForgeryToken()').val() },
                data: { "refferalUserId" : refferalUserId, "taskId" : taskId },

                success: function (response) {
                    console.log(response);
                    $.Notification.autoHideNotify('success', 'top center', 'پیام سیستم ', response.message);
                    setTimeout(function() { 
                            
                        location.reload();
                    }, 1200)
                
                },
                failure: function (response) {
                    console.log(5, response)
                    $.Notification.autoHideNotify('error', 'top center', 'پیام سیستم ', response.message);
                }
            });

		}
		
		function SetRefferalUserApproval(taskId, approval)
		{
            
			$.ajax({
                dataType: 'json',
                type: 'POST',
                url: '@Url.Page("./Index", "SetRefferalUserApproval")',
                headers: { "RequestVerificationToken": $('@Html.AntiForgeryToken()').val() },
                data: { "taskId" : taskId, "approval" : approval },

                success: function (response) {
                    console.log(response);
                    $.Notification.autoHideNotify('success', 'top center', 'پیام سیستم ', response.message);
                    setTimeout(function() { 
                            
                        location.reload();
                    }, 1200)
                
                },
                failure: function (response) {
                    console.log(5, response)
                    $.Notification.autoHideNotify('error', 'top center', 'پیام سیستم ', response.message);
                }
            });

		}

		function UpdateDate(type = null) {
			$.ajax({
				dataType: 'json',
				type: 'POST',
				url: '@Url.Page("./Index", "Date")',
				headers: { "RequestVerificationToken": $('@Html.AntiForgeryToken()').val() },
				data: { "type": type },

				success: function(response) {
					$('#DeadlineDate').val(response.date);
					$('#DeadlineDate').css('background-color', '#fff')
				},
				failure: function(response) {

				}
			});
		}

		function SetDeadlineDate(taskId)
		{
			var date = $("#DeadlineDate").val();

            if (date == "") {

				$.Notification.autoHideNotify('error', 'top center', 'پیام سیستم ', 'لطفا تاریخ را وارد کنید');
                return   
			}

			$.ajax({
                dataType: 'json',
                type: 'POST',
                url: '@Url.Page("./Index", "SetDeadlineDate")',
                headers: { "RequestVerificationToken": $('@Html.AntiForgeryToken()').val() },
                data: { "taskId" : taskId, "date" : date },

                success: function (response) {
                    console.log(response);
                    $.Notification.autoHideNotify('success', 'top center', 'پیام سیستم ', response.message);
                    setTimeout(function() { 
                            
                        location.reload();
                    }, 1200)
                
                },
                error: function (response) {
                    console.log(5, response)
                    $.Notification.autoHideNotify('error', 'top center', 'پیام سیستم ', response.responseJSON.message);
                }
            });

		}

		function SetDeadlineExtentionApproval(taskId, approval)
		{
            
			$.ajax({
                dataType: 'json',
                type: 'POST',
                url: '@Url.Page("./Index", "SetDeadlineExtentionApproval")',
                headers: { "RequestVerificationToken": $('@Html.AntiForgeryToken()').val() },
                data: { "taskId" : taskId, "approval" : approval },

                success: function (response) {
                    console.log(response);
                    $.Notification.autoHideNotify('success', 'top center', 'پیام سیستم ', response.message);
                    setTimeout(function() { 
                            
                        location.reload();
                    }, 1200)
                
                },
                failure: function (response) {
                    console.log(5, response)
                    $.Notification.autoHideNotify('error', 'top center', 'پیام سیستم ', response.message);
                }
            });

		}

		function SetImpossibility(taskId)
		{
            var impossibilityDescription = $("#ImpossibilityDescription").val();
			
            if (impossibilityDescription == "") {

				$.Notification.autoHideNotify('error', 'top center', 'پیام سیستم ', 'لطفا توضیحات را وارد کنید');
				return;
			}

			$.ajax({
                dataType: 'json',
                type: 'POST',
                url: '@Url.Page("./Index", "SetImpossibility")',
                headers: { "RequestVerificationToken": $('@Html.AntiForgeryToken()').val() },
                data: { "impossibilityDescription" : impossibilityDescription, "taskId" : taskId },

                success: function (response) {
                    console.log(response);
                    $.Notification.autoHideNotify('success', 'top center', 'پیام سیستم ', response.message);
                    setTimeout(function() { 
                            
                        location.reload();
                    }, 1200)
                
                },
                failure: function (response) {
                    console.log(5, response)
                    $.Notification.autoHideNotify('error', 'top center', 'پیام سیستم ', response.message);
                }
            });

		}

		function SetImpossibilityApproval(taskId, approval)
		{
            
			$.ajax({
                dataType: 'json',
                type: 'POST',
                url: '@Url.Page("./Index", "SetImpossibilityApproval")',
                headers: { "RequestVerificationToken": $('@Html.AntiForgeryToken()').val() },
                data: { "taskId" : taskId, "approval" : approval },

                success: function (response) {
                    console.log(response);
                    $.Notification.autoHideNotify('success', 'top center', 'پیام سیستم ', response.message);
                    setTimeout(function() { 
                            
                        location.reload();
                    }, 1200)
                
                },
                failure: function (response) {
                    console.log(5, response)
                    $.Notification.autoHideNotify('error', 'top center', 'پیام سیستم ', response.message);
                }
            });

		}

		function SetDone(taskId)
		{
			$.ajax({
                dataType: 'json',
                type: 'POST',
                url: '@Url.Page("./Index", "SetDone")',
                headers: { "RequestVerificationToken": $('@Html.AntiForgeryToken()').val() },
                data: { "taskId" : taskId },

                success: function (response) {
                    console.log(response);
                    $.Notification.autoHideNotify('success', 'top center', 'پیام سیستم ', response.message);
                    setTimeout(function() { 
                            
                        location.reload();
                    }, 1200)
                
                },
                failure: function (response) {
                    console.log(5, response)
                    $.Notification.autoHideNotify('error', 'top center', 'پیام سیستم ', response.message);
                }
            });

		}

		function SetDoneApproval(taskId, approval)
		{
            
			$.ajax({
                dataType: 'json',
                type: 'POST',
                url: '@Url.Page("./Index", "SetDoneApproval")',
                headers: { "RequestVerificationToken": $('@Html.AntiForgeryToken()').val() },
                data: { "taskId" : taskId, "approval" : approval },

                success: function (response) {
                    console.log(response);
                    $.Notification.autoHideNotify('success', 'top center', 'پیام سیستم ', response.message);
                    setTimeout(function() { 
                            
                        location.reload();
                    }, 1200)
                
                },
                failure: function (response) {
                    console.log(5, response)
                    $.Notification.autoHideNotify('error', 'top center', 'پیام سیستم ', response.message);
                }
            });

		}

		function DeleteTask(id) { 

            swal({
                title: "",
                text: "آیا از حذف وظیفه اطمینان دارید؟",
                type: "warning",
                showCancelButton: true,
                confirmButtonColor: "#DD6B55",
                confirmButtonText: "بله",
                cancelButtonText: "خیر",
                closeOnConfirm: true,
                closeOnCancel: true
            }, function (isConfirm) {
                if (isConfirm) {
                  
                    $.ajax({
                        dataType: 'json',
                        type: 'POST',
                        url: '@Url.Page("./Index", "DeleteTask")',
                        headers: { "RequestVerificationToken": $('@Html.AntiForgeryToken()').val() },
                        data: { "id" : id },

                        success: function (response) {
                            console.log(response);
                            $.Notification.autoHideNotify('success', 'top center', 'پیام سیستم ', response.message);
                            setTimeout(function() { 
                            
                                location.reload();
                            }, 1200)
                
                        },
                        failure: function (response) {
                            console.log(5, response)
                            $.Notification.autoHideNotify('error', 'top center', 'پیام سیستم ', response.message);
                        }
                    });
                    
                }
            });
        }



    </script>    
}
